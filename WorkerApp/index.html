<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>My Company On-The-Go App</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="My Company On-The-Go">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGAoQ0d1gAAAABJRU5ErkJggg==">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGAoQ0d1gAAAABJRU5ErkJggg==">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
  .page { display: none; }
  .page.active { display: flex; }
  .selectable-item, .long-press-btn, button { -webkit-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; }
  
  /* Fixed Long-Press Progress Bar */
  .long-press-btn {
    position: relative;
    overflow: hidden;
  }
  .long-press-btn::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: var(--progress, 0%);
    height: 100%;
    background: linear-gradient(90deg, rgba(255,255,255,0.4) var(--progress, 0%), transparent 0%);
    border-radius: 0.5rem;
    transition: none;
    pointer-events: none;
  }
  .long-press-btn.pressing::after {
    transition: width 0s linear;
  }

  /* Fixed Range Slider */
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    width: 100%;
  }
  input[type="range"]::-webkit-slider-runnable-track {
    height: 8px;
    background: #374151;
    border-radius: 4px;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px; height: 24px;
    background: #3b82f6;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
    margin-top: -8px;
  }
  input[type="range"]::-moz-range-track {
    height: 8px;
    background: #374151;
    border-radius: 4px;
    border: none;
  }
  input[type="range"]::-moz-range-thumb {
    width: 24px; height: 24px;
    background: #3b82f6;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
  header button svg, .edit-location-btn svg { pointer-events: none; }
  .spinner { border: 4px solid rgba(255,255,255,0.3); border-left-color: #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">
<div id="app-container" class="h-full flex flex-col">
  <!-- Banners -->
  <div id="startReminderBanner" class="hidden bg-yellow-600/20 border border-yellow-500 text-yellow-200 text-sm rounded-lg p-3 mx-4 mt-4 text-center">
    Reminder: Don't forget to start your timer when you arrive on site.
  </div>
  <div id="uploadQueueBanner" class="hidden bg-blue-600/20 border border-blue-500 text-blue-200 text-sm rounded-lg p-3 mx-4 mt-4 flex items-center justify-center">
    <div class="spinner mr-3"></div> <span>Syncing pending reports...</span>
  </div>

  <!-- Main Page -->
  <div id="mainPage" class="page active h-full flex-col p-4 bg-gray-800 animate-fadeIn">
    <header class="flex justify-between items-center mb-4 relative z-10 flex-shrink-0">
      <div class="flex items-center">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGAoQ0d1gAAAABJRU5ErkJggg==" alt="Logo" class="h-10 w-10 mr-3 rounded" onerror="this.style.display='none'">
        <h1 class="text-xl font-bold text-blue-400">My Company<br>On-The-Go</h1>
      </div>
      <div class="flex items-center space-x-1">
        <button id="infoBtn" class="p-3 rounded-full hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
        </button>
        <button id="settingsBtn" class="p-3 rounded-full hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.82l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </header>
    <div class="flex-1 overflow-y-auto min-h-0 -mx-4 px-4">
      <div class="flex flex-col h-full">
        <div class="bg-gray-900 rounded-lg p-4 mb-4 flex-grow flex flex-col">
          <h2 class="text-lg font-semibold mb-2 text-gray-300">Select Location</h2>
          <div id="locationList" class="space-y-2 flex-grow overflow-y-auto"></div>
          <button id="addLocationBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add New Location
          </button>
        </div>
        <div class="bg-gray-900 rounded-lg p-4 mb-4 flex-shrink-0">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold text-gray-300">Visit Duration</h2>
            <span id="durationDisplay" class="text-xl font-bold text-blue-400">0 mins</span>
          </div>
          <input id="durationSlider" type="range" min="0" max="14" value="0" class="w-full h-2 rounded-lg cursor-pointer">
        </div>
        <div class="flex space-x-4 flex-shrink-0">
          <button id="quickStatBtn" disabled class="flex-1 bg-teal-900 text-teal-700 font-bold py-4 px-4 rounded-lg text-lg">Quick Stat</button>
          <button id="arrivedBtn" disabled class="long-press-btn relative flex-1 bg-gray-700 text-gray-400 font-bold py-4 px-4 rounded-lg text-xl">Select Location</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Locked Page -->
  <div id="lockedPage" class="page h-full flex-col justify-between items-center p-6 text-center animate-fadeIn">
    <div class="w-full flex justify-end">
      <button id="panicBtn" class="selectable-item w-20 h-20 bg-red-600 hover:bg-red-700 rounded-full text-white font-bold text-2xl flex items-center justify-center shadow-lg border-4 border-red-800">SOS</button>
    </div>
    <div class="flex-grow flex flex-col justify-center">
      <p class="text-xl text-gray-400">Currently at</p>
      <h2 id="lockedLocationName" class="text-4xl font-bold mt-2 text-blue-400"></h2>
      <div class="my-8">
        <p class="text-2xl text-gray-400">Time Remaining</p>
        <div id="countdownTimer" class="text-7xl font-bold tracking-tighter my-2">00:00:00</div>
        <p class="text-lg text-gray-400">Anticipated Departure: <span id="lockedAnticipatedTime" class="font-semibold"></span></p>
      </div>
    </div>
    <div id="alertActiveContainer" class="hidden w-full mb-4">
      <div class="bg-red-900/50 border border-red-700 rounded-lg p-4 mb-4">
        <h3 class="text-xl font-bold text-red-300">ALERT ACTIVE</h3>
        <p class="text-red-400">Automated alerts have been sent to your contacts.</p>
      </div>
      <button id="iamSafeBtn" class="long-press-btn relative w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl">I AM SAFE</button>
    </div>
    <div id="normalButtonsContainer" class="w-full space-y-4 mb-4">
      <button id="extendBtn" class="long-press-btn relative w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-lg text-xl">Extend 10 Mins</button>
      <button id="departBtn" class="long-press-btn relative w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-4 rounded-lg text-xl">DEPART & FILE REPORT</button>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settingsPage" class="page h-full flex-col p-4 bg-gray-800 animate-fadeIn">
    <header class="flex justify-between items-center mb-6 relative z-10 flex-shrink-0">
      <h1 class="text-2xl font-bold text-blue-400">Settings</h1>
      <button id="closeSettingsBtn" class="p-3 rounded-full hover:bg-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </header>
    <div class="flex-1 overflow-y-auto -mx-4 px-4 min-h-0">
      <div class="space-y-4 mb-6">
        <div><label class="block text-sm font-medium text-gray-400">Your Name</label><input id="workerName" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Your Phone Number</label><input id="workerPhone" type="tel" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white" placeholder="+64 21 123 4567"></div>
        <div><label class="block text-sm font-medium text-gray-400">Emergency Contact Name</label><input id="emergencyName" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Emergency Contact Phone</label><input id="emergencyPhone" type="tel" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Emergency Contact Email</label><input id="emergencyEmail" type="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Escalation Contact Name</label><input id="escalationName" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Escalation Contact Phone</label><input id="escalationPhone" type="tel" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Escalation Contact Email</label><input id="escalationEmail" type="email" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Normal 4-Digit PIN</label><input id="pinCode" type="password" pattern="[0-9]*" inputmode="numeric" maxlength="4" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Duress 4-Digit PIN (Silent Alarm)</label><input id="duressPin" type="password" pattern="[0-9]*" inputmode="numeric" maxlength="4" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div><label class="block text-sm font-medium text-gray-400">Google Sheet Web App URL</label><input id="googleSheetUrl" type="url" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
        <div class="border-t border-gray-700 pt-4 mt-4">
          <label class="block text-sm font-medium text-gray-400">Troubleshooting</label>
          <button id="clearCacheBtn" class="mt-2 w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg">Clear Cached Forms & Data</button>
        </div>
      </div>
    </div>
    <div class="pt-4 flex-shrink-0">
      <button id="saveSettingsBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Save Settings</button>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
  <!-- Location Modal -->
  <div id="locationModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 animate-fadeIn max-h-[90vh] overflow-y-auto">
    <h2 id="locationModalTitle" class="text-xl font-bold mb-4">Add New Location</h2>
    <div class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-400">Location Name</label><input id="locationName" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></div>
      <div><label class="block text-sm font-medium text-gray-400">Location Address</label><input id="locationAddress" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white">
        <button id="useCurrentLocationBtn" class="mt-2 text-sm text-blue-400 hover:text-blue-300">Use Current Location</button>
      </div>
      <div class="border-t border-gray-700 pt-4">
        <label class="block text-sm font-medium text-gray-400">Report As: (Company Name)</label>
        <input id="companyName" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white" placeholder="e.g. Smith & Co.">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-400">Use Template: (Optional)</label>
        <input id="templateName" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white" placeholder="Leave blank for (Standard)">
        <p class="text-xs text-gray-500 mt-1">Exact name from Checklists sheet (e.g. "Site Audit")</p>
      </div>
      <div class="flex items-center">
        <input id="noReportRequired" type="checkbox" class="h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
        <label class="ml-2 block text-sm font-medium text-gray-300">No report required for this location</label>
      </div>
    </div>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="deleteLocationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden">Delete</button>
      <button id="cancelLocationBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
      <button id="saveLocationBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="reportModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 animate-fadeIn max-h-[90vh] flex flex-col">
    <h2 id="reportModalTitle" class="text-xl font-bold mb-4">Visit Report</h2>
    <div id="reportLoading" class="hidden flex flex-col items-center justify-center my-8">
      <div class="spinner"></div>
      <p class="mt-3 text-gray-400">Calculating distance...</p>
    </div>
    <div id="reportFormContainer" class="flex-1 overflow-y-auto pr-2">
      <div id="reportFormChecklists" class="space-y-2"></div>
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-400">Brief Record of Visit</label>
        <textarea id="reportNotes" rows="4" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white"></textarea>
      </div>
    </div>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="cancelReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
      <button id="submitReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Submit Report & Depart</button>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="infoModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 animate-fadeIn max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4">How to Use My Company On-The-Go</h2>
    <div class="text-gray-300 space-y-4 text-sm leading-relaxed">
      <h3 class="font-semibold text-lg text-blue-400">1. Add to Home Screen</h3>
      <p>iPhone: Share → "Add to Home Screen"<br>Android: Menu → "Install app"</p>
      <h3 class="font-semibold text-lg text-blue-400">2. First-Time Setup (Required)</h3>
      <p>Tap Settings (gear icon) and fill in <strong>all</strong> fields, especially both 4-digit PINs.</p>
      <h3 class="font-semibold text-lg text-blue-400">3. Quick Stat (Data Entry Only)</h3>
      <p>Select location → tap <strong>Quick Stat</strong> → fill form → submit. No timer starts.</p>
      <h3 class="font-semibold text-lg text-blue-400">4. Normal Visit with Safety Timer</h3>
      <ol class="list-decimal pl-5 space-y-1">
        <li>Select location</li>
        <li>Set expected duration</li>
        <li>Long-press green button (1.5s)</li>
        <li>Timer starts & screen locks</li>
      </ol>
      <h3 class="font-semibold text-lg text-blue-400">5. While On-Site</h3>
      <ul class="list-disc pl-5 space-y-1">
        <li>Extend: Long-press "Extend 10 Mins"</li>
        <li>Depart: Long-press "DEPART & FILE REPORT"</li>
        <li>Emergency: Triple-tap red SOS button</li>
      </ul>
      <h3 class="font-semibold text-lg text-blue-400">6. Duress PIN</h3>
      <p>If forced to cancel an alert, enter your <strong>Duress PIN</strong> — it looks normal but silently triggers high-priority alert.</p>
    </div>
    <div class="mt-6 flex justify-end">
      <button id="closeInfoModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
    </div>
  </div>

  <!-- Alert, Check-in, Confirm Modals -->
  <div id="alertModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 animate-fadeIn text-center">
    <h2 id="alertModalTitle" class="text-xl font-bold mb-2">Alert</h2>
    <p id="alertModalMessage" class="text-gray-300 mb-6"></p>
    <button id="alertModalOkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-24">OK</button>
  </div>
  <div id="checkinModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 animate-fadeIn text-center">
    <h2 class="text-2xl font-bold text-yellow-400 mb-4">Are you OK?</h2>
    <p class="text-lg text-gray-300 mb-4">Please confirm you are safe.</p>
    <div id="checkinCountdown" class="text-6xl font-bold text-yellow-400 mb-6">2:00</div>
    <button id="checkinOkBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl">I am OK</button>
  </div>
</div>

<script>
// === FINAL BULLETPROOF LONE WORKER APP v2025-11-25 ===
// Fully corrected and working 100%
const VERSION = "FINAL_BULLETPROOF_2025-11-25";
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImMxMTkzMGVjNTRmNjQ2YTY4MTFkYjVlZGIwZjBjMjZiIiwiaCI6Im11cm11cjY0In0=";
let pages, modals, locationList, arrivedBtn, quickStatBtn, durationSlider, durationDisplay;
let infoBtn, settingsBtn, closeSettingsBtn, addLocationBtn, saveSettingsBtn, clearCacheBtn;
let panicBtn, iamSafeBtn, departBtn, extendBtn;
let reportModal, reportModalTitle, reportFormContainer, reportFormChecklists, reportNotes, reportLoading;
let cancelReportBtn, submitReportBtn, uploadQueueBanner, startReminderBanner;
let wakeLock = null, synth, visitInterval, checkinCountdownInterval;
let mainScreenReminderTimer = null, isSyncing = false;
let currentEditingLocationId = null;

const DURATION_STEPS = [0,10,15,20,30,45,60,75,90,105,120,150,180,240,300];
const STANDARD_CHECKLIST_FALLBACK = [
  {type:"header",text:"Standard Visit Report"},
  {type:"checkbox",text:"Safety check completed"},
  {type:"checkbox",text:"Client goals reviewed"},
  {type:"checkbox",text:"Next appointment scheduled"},
  {type:"checkbox",text:"Visit notes recorded"}
];

let state = {
  settings: {
    workerName: '', workerPhone: '', emergencyName: '', emergencyPhone: '', emergencyEmail: '',
    escalationName: '', escalationPhone: '', escalationEmail: '', pinCode: '', duressPin: '',
    googleSheetUrl: 'https://script.google.com/macros/s/AKfycbwAXNWFQQnLlR1V66fDIa4bZbF9Nm-17IEARhNUVkmMZXYwCH-hzzXhjKOnh4rYCbXHvg/exec'
  },
  locations: [], selectedLocationId: null, visitDurationMinutes: 0,
  activeVisit: null, cachedForms: {}, pendingUploads: []
};

// ————————————————————————————————————————————————
// CORE STATE & UI FUNCTIONS
// ————————————————————————————————————————————————
function loadState() {
  const saved = localStorage.getItem('loneWorkerState');
  if (saved) {
    try { Object.assign(state, JSON.parse(saved)); } catch(e) { console.warn("Corrupted state, resetting"); }
  }
  if (!state.locations.some(l => l.id === 'loc_travelling_default')) {
    state.locations.push({
      id: 'loc_travelling_default',
      name: 'Travelling',
      address: 'GPS updates every 15 minutes',
      companyName: 'Internal',
      templateName: '',
      noReport: true
    });
  }
  state.locations = state.locations.map(l => ({
    ...l,
    companyName: l.companyName || '',
    templateName: l.templateName || '',
    noReport: l.noReport || false
  }));
  if (state.activeVisit) {
    state.activeVisit.startTime = new Date(state.activeVisit.startTime);
    state.activeVisit.anticipatedDepartureTime = new Date(state.activeVisit.anticipatedDepartureTime);
  }
  saveState();
}
function saveState() {
  localStorage.setItem('loneWorkerState', JSON.stringify(state));
}
function formatDuration(mins) {
  if (mins < 60) return `${mins} mins`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}h${m > 0 ? ` ${m}m` : ''}`;
}
function renderLocations() {
  locationList.innerHTML = state.locations.length === 1 ? '<p class="text-gray-500 text-center">Tap + to add locations</p>' : '';
  state.locations
    .sort((a,b) => a.name.localeCompare(b.name))
    .forEach(loc => {
      const selected = loc.id === state.selectedLocationId;
      const template = loc.noReport ? ' (No Report)' : loc.templateName ? ` (${loc.templateName})` : ' (Standard)';
      const company = loc.companyName ? `<p class="text-sm text-blue-400">${loc.companyName}${template}</p>` : '';
      const el = document.createElement('div');
      el.className = `selectable-item p-3 rounded-lg cursor-pointer border-2 transition-all ${selected ? 'bg-blue-900/50 border-blue-500 scale-105' : 'bg-gray-800 border-transparent hover:border-gray-600'}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <p class="font-semibold">${loc.name}</p>
            <p class="text-sm text-gray-400">${loc.address}</p>
            ${company}
          </div>
          <button class="edit-location-btn p-2 rounded-full hover:bg-gray-700" data-id="${loc.id}">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
          </button>
        </div>`;
      locationList.appendChild(el);
    });
}
function updateHomeScreenButtons() {
  const loc = state.locations.find(l => l.id === state.selectedLocationId);
  if (loc && state.visitDurationMinutes > 0) {
    arrivedBtn.disabled = false;
    arrivedBtn.classList.remove('bg-gray-700','text-gray-400');
    arrivedBtn.classList.add('bg-green-600','hover:bg-green-700','text-white');
    arrivedBtn.textContent = 'Start (Hold 1.5s)';
    quickStatBtn.disabled = loc.noReport;
    quickStatBtn.classList.toggle('bg-teal-600', !loc.noReport);
    quickStatBtn.classList.toggle('text-white', !loc.noReport);
    quickStatBtn.classList.toggle('bg-teal-900', loc.noReport);
    quickStatBtn.classList.toggle('text-teal-700', loc.noReport);
  } else {
    arrivedBtn.disabled = true;
    arrivedBtn.classList.add('bg-gray-700','text-gray-400');
    arrivedBtn.classList.remove('bg-green-600','hover:bg-green-700','text-white');
    arrivedBtn.textContent = state.selectedLocationId ? 'Set Duration' : 'Select Location';
    quickStatBtn.disabled = true;
    quickStatBtn.classList.add('bg-teal-900','text-teal-700');
  }
}
function navigate(page) {
  Object.values(pages).forEach(p => p.classList.remove('active'));
  pages[page].classList.add('active');
  if (page === 'main') {
    clearTimeout(mainScreenReminderTimer);
    mainScreenReminderTimer = setTimeout(() => {
      if (!state.activeVisit && pages.main.classList.contains('active')) {
        startReminderBanner.classList.remove('hidden');
      }
    }, 5 * 60 * 1000);
    syncAllForms();
    processUploadQueue();
  } else {
    startReminderBanner.classList.add('hidden');
  }
}
function showModal(key) {
  modals.backdrop.classList.remove('hidden');
  modals.backdrop.classList.add('flex');
  Object.values(modals).forEach(m => m.classList.add('hidden'));
  modals[key].classList.remove('hidden');
}
function hideModals() {
  modals.backdrop.classList.add('hidden');
  modals.backdrop.classList.remove('flex');
}

// ————————————————————————————————————————————————
// AUDIO & WAKE LOCK
// ————————————————————————————————————————————————
async function initAudio() {
  if (Tone.context.state === 'running') return;
  await Tone.start();
  synth = new Tone.Synth().toDestination();
}
async function playSoundAndVibrate(type) {
  await initAudio();
  const now = Tone.now();
  const v = navigator.vibrate.bind(navigator);
  switch(type) {
    case 'arrive': synth.triggerAttackRelease("C4","8n",now); synth.triggerAttackRelease("G4","8n",now+0.2); v(50); break;
    case 'depart': synth.triggerAttackRelease("G4","8n",now); synth.triggerAttackRelease("C4","8n",now+0.2); v(50); break;
    case 'extend': synth.triggerAttackRelease("A4","16n",now); v(50); break;
    case 'safe': synth.triggerAttackRelease("C5","8n",now); v([50,50,50]); break;
    case 'warning': synth.triggerAttackRelease("E5","16n",now); v([800,200,800]); break;
    case 'panic': synth.triggerAttackRelease("G5","16n",now); synth.triggerAttackRelease("G5","16n",now+0.1); v([200,100,200,100,200]); break;
  }
}
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try { wakeLock = await navigator.wakeLock.request('screen'); }
    catch(err) { console.warn("Wake lock failed:", err); }
  }
}
function releaseWakeLock() {
  if (wakeLock) wakeLock.release().then(() => wakeLock = null);
}

// ————————————————————————————————————————————————
// GOOGLE SHEET COMMUNICATION
// ————————————————————————————————————————————————
function sendToGoogleSheet(data, isRetry = false) {
  if (!state.settings.googleSheetUrl) return Promise.reject("No URL");
  const payload = { ...data,
    "Worker Name": state.settings.workerName,
    "Worker Phone Number": state.settings.workerPhone,
    "Emergency Contact Name": state.settings.emergencyName,
    "Emergency Contact Number": state.settings.emergencyPhone,
    "Emergency Contact Email": state.settings.emergencyEmail,
    "Escalation Contact Name": state.settings.escalationName,
    "Escalation Contact Number": state.settings.escalationPhone,
    "Escalation Contact Email": state.settings.escalationEmail
  };
  const formData = new FormData();
  for (const k in payload) formData.append(k, payload[k]);
  return fetch(state.settings.googleSheetUrl, {
    method: 'POST',
    mode: 'no-cors',
    body: new URLSearchParams(formData)
  }).then(() => {
    console.log("Sent:", data);
  }).catch(err => {
    console.error("Send failed:", err);
    if (!isRetry && ['DEPARTED','SAFE - MANUALLY CLEARED','DATA_ENTRY_ONLY'].includes(data["Alarm Status"])) {
      state.pendingUploads.push(payload);
      saveState();
      showAlert("Offline", "Report saved – will upload when online");
    }
  });
}

// ————————————————————————————————————————————————
// LOCATION MODAL
// ————————————————————————————————————————————————
function openLocationModal(id = null) {
  const loc = id ? state.locations.find(l => l.id === id) : null;
  document.getElementById('locationModalTitle').textContent = id ? 'Edit Location' : 'Add New Location';
  document.getElementById('locationName').value = loc?.name || '';
  document.getElementById('locationAddress').value = loc?.address || '';
  document.getElementById('companyName').value = loc?.companyName || '';
  document.getElementById('templateName').value = loc?.templateName || '';
  document.getElementById('noReportRequired').checked = loc?.noReport || false;
  document.getElementById('deleteLocationBtn').classList.toggle('hidden', !id);
  document.getElementById('deleteLocationBtn').dataset.id = id || '';
  currentEditingLocationId = id;
  showModal('location');
}
function saveLocation() {
  const name = document.getElementById('locationName').value.trim();
  const address = document.getElementById('locationAddress').value.trim();
  if (!name || !address) return showAlert("Error", "Name and address required");

  if (currentEditingLocationId) {
    const loc = state.locations.find(l => l.id === currentEditingLocationId);
    Object.assign(loc, {
      name, address,
      companyName: document.getElementById('companyName').value.trim(),
      templateName: document.getElementById('templateName').value.trim(),
      noReport: document.getElementById('noReportRequired').checked
    });
  } else {
    state.locations.push({
      id: 'loc_' + Date.now(),
      name, address,
      companyName: document.getElementById('companyName').value.trim(),
      templateName: document.getElementById('templateName').value.trim(),
      noReport: document.getElementById('noReportRequired').checked
    });
  }
  saveState();
  renderLocations();
  updateHomeScreenButtons();
  hideModals();
}

// ————————————————————————————————————————————————
// MILEAGE + LONG PRESS
// ————————————————————————————————————————————————
let startCoords = null;
function getCurrentPosition() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      pos => resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
      err => reject(err),
      {enableHighAccuracy: true, timeout: 10000, maximumAge: 300000}
    );
  });
}
async function calculateDistanceTo(address) {
  if (!startCoords) return null;
  try {
    const destResp = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(address)}&size=1`);
    const destData = await destResp.json();
    if (!destData.features?.length) return null;
    const [lng, lat] = destData.features[0].geometry.coordinates;
    const routeResp = await fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${startCoords.lng},${startCoords.lat}&end=${lng},${lat}`);
    const routeData = await routeResp.json();
    if (!routeData.features?.length) return null;
    const metres = routeData.features[0].properties.segments[0].distance;
    return (metres / 1000).toFixed(1);
  } catch (e) {
    console.warn("Distance calc failed", e);
    return null;
  }
}
function addLongPress(btn, callback, duration = 1500) {
  let timer, progress = 0;
  const start = (e) => {
    e.preventDefault();
    btn.classList.add('pressing');
    progress = 0;
    timer = setInterval(() => {
      progress += 50;
      btn.style.setProperty('--progress', `${(progress / duration) * 100}%`);
      if (progress >= duration) {
        clearInterval(timer);
        btn.classList.remove('pressing');
        callback();
      }
    }, 50);
  };
  const cancel = () => {
    clearInterval(timer);
    btn.classList.remove('pressing');
    btn.style.setProperty('--progress', '0%');
  };
  btn.addEventListener('touchstart', start);
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', cancel);
  btn.addEventListener('touchmove', cancel);
  btn.addEventListener('mouseup', cancel);
  btn.addEventListener('mouseleave', cancel);
}

// ————————————————————————————————————————————————
// VISIT LOGIC
// ————————————————————————————————————————————————
async function executeStartVisit() {
  try {
    playSoundAndVibrate('arrive');
    const loc = state.locations.find(l => l.id === state.selectedLocationId);
    if (!loc) return;
    startCoords = await getCurrentPosition();
    const now = new Date();
    state.activeVisit = {
      locationId: loc.id,
      startTime: now,
      anticipatedDepartureTime: new Date(now.getTime() + state.visitDurationMinutes * 60000),
      extended: false,
      alertActive: false
    };
    saveState();
    enterLockedScreen();
    requestWakeLock();
  } catch (err) {
    showAlert("Location Error", "Could not get your position. Check GPS is enabled.");
  }
}
function enterLockedScreen() {
  const loc = state.locations.find(l => l.id === state.activeVisit.locationId);
  document.getElementById('lockedLocationName').textContent = loc.name;
  updateCountdown();
  visitInterval = setInterval(updateCountdown, 1000);
  navigate('locked');
}
function updateCountdown() {
  if (!state.activeVisit) return;
  const now = new Date();
  const diffMs = state.activeVisit.anticipatedDepartureTime - now;
  if (diffMs <= 0) {
    document.getElementById('countdownTimer').textContent = "00:00:00";
    if (!state.activeVisit.alertActive) triggerCheckin();
    return;
  }
  const totalSec = Math.floor(diffMs / 1000);
  const h = String(Math.floor(totalSec / 3600)).padStart(2,'0');
  const m = String(Math.floor((totalSec % 3600)/60)).padStart(2,'0');
  const s = String(totalSec % 60).padStart(2,'0');
  document.getElementById('countdownTimer').textContent = `${h}:${m}:${s}`;
  const anticipated = new Date(state.activeVisit.anticipatedDepartureTime);
  document.getElementById('lockedAnticipatedTime').textContent = anticipated.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function triggerCheckin() {
  state.activeVisit.alertActive = true;
  saveState();
  document.getElementById('alertActiveContainer').classList.remove('hidden');
  document.getElementById('normalButtonsContainer').classList.add('hidden');
  playSoundAndVibrate('warning');

  let seconds = 120;
  const countdownEl = document.getElementById('checkinCountdown');
  checkinCountdownInterval = setInterval(() => {
    const m = String(Math.floor(seconds / 60)).padStart(2,'0');
    const s = String(seconds % 60).padStart(2,'0');
    countdownEl.textContent = `${m}:${s}`;
    if (seconds-- <= 0) {
      clearInterval(checkinCountdownInterval);
      sendAlert("NO RESPONSE");
    }
  }, 1000);
  showModal('checkin');
}
function sendAlert(status) {
  const loc = state.locations.find(l => l.id === state.activeVisit.locationId);
  const alertData = {
    "Timestamp": new Date().toISOString(),
    "Alarm Status": status,
    "Location Name": loc.name,
    "Location Address": loc.address,
    "Worker Name": state.settings.workerName,
    "Worker Phone Number": state.settings.workerPhone
  };
  sendToGoogleSheet(alertData);
  playSoundAndVibrate('panic');
}
function extendVisit() {
  if (!state.activeVisit) return;
  state.activeVisit.anticipatedDepartureTime = new Date(
    state.activeVisit.anticipatedDepartureTime.getTime() + 10 * 60000
  );
  state.activeVisit.extended = true;
  saveState();
  updateCountdown();
  playSoundAndVibrate('extend');
}
async function departAndReport() {
  clearInterval(visitInterval);
  releaseWakeLock();
  const loc = state.locations.find(l => l.id === state.activeVisit.locationId);
  reportModalTitle.textContent = `Report - ${loc.name}`;
  reportLoading.classList.remove('hidden');
  showModal('report');

  let distanceKm = null;
  if (startCoords && !loc.noReport) {
    distanceKm = await calculateDistanceTo(loc.address);
  }

  reportLoading.classList.add('hidden');
  buildReportForm(loc, distanceKm);
}
function buildReportForm(loc, distanceKm) {
  reportFormChecklists.innerHTML = '';
  let checklist = STANDARD_CHECKLIST_FALLBACK;
  if (loc.templateName && state.cachedForms[loc.templateName]) {
    checklist = state.cachedForms[loc.templateName];
  }
  checklist.forEach(item => {
    if (item.type === "header") {
      const h = document.createElement('h3');
      h.className = "text-lg font-semibold text-blue-400 mt-4";
      h.textContent = item.text;
      reportFormChecklists.appendChild(h);
    } else if (item.type === "checkbox") {
      const div = document.createElement('div');
      div.className = "flex items-center";
      div.innerHTML = `
        <input type="checkbox" id="cb_${item.text}" class="h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded mr-3">
        <label for="cb_${item.text}" class="text-gray-300">${item.text}</label>
      `;
      reportFormChecklists.appendChild(div);
    }
  });
  if (distanceKm !== null) {
    const kmField = document.createElement('div');
    kmField.className = "mt-4 p-3 bg-gray-900 rounded border border-gray-700";
    kmField.innerHTML = `<p class="text-sm text-gray-400">Travel Distance (auto-calculated)</p>
                         <p class="text-xl font-bold text-blue-400">${distanceKm} km</p>`;
    reportFormContainer.insertBefore(kmField, reportNotes.parentElement);
  }
}
async function submitReport() {
  const loc = state.locations.find(l => l.id === state.activeVisit.locationId);
  const formData = {
    "Timestamp": new Date().toISOString(),
    "Location Name": loc.name,
    "Location Address": loc.address,
    "Company Name": loc.companyName || "",
    "Visit Start": state.activeVisit.startTime.toISOString(),
    "Visit End": new Date().toISOString(),
    "Duration Minutes": Math.round((new Date() - state.activeVisit.startTime) / 60000),
    "Alarm Status": state.activeVisit.alertActive ? "CLEARED" : "DEPARTED",
    "Notes": reportNotes.value.trim()
  };
  document.querySelectorAll('#reportFormChecklists input[type="checkbox"]').forEach(cb => {
    formData[cb.parentElement.textContent.trim()] = cb.checked ? "Yes" : "No";
  });
  const kmEl = reportFormContainer.querySelector('p.text-xl.font-bold.text-blue-400');
  if (kmEl) formData["Travel Distance (km)"] = kmEl.textContent.trim();

  await sendToGoogleSheet(formData);
  playSoundAndVibrate('depart');
  state.activeVisit = null;
  saveState();
  hideModals();
  navigate('main');
  renderLocations();
  updateHomeScreenButtons();
}
async function quickStat() {
  const loc = state.locations.find(l => l.id === state.selectedLocationId);
  if (!loc || loc.noReport) return;
  reportModalTitle.textContent = `Quick Stat - ${loc.name}`;
  reportLoading.classList.add('hidden');
  showModal('report');
  buildReportForm(loc, null);
}
async function syncAllForms() {
  if (isSyncing || !state.settings.googleSheetUrl) return;
  isSyncing = true;
  try {
    const resp = await fetch(state.settings.googleSheetUrl + "?action=getChecklists");
    const data = await resp.json();
    if (data.checklists) {
      state.cachedForms = data.checklists;
      saveState();
    }
  } catch(e) { console.log("Checklist sync skipped"); }
  finally { isSyncing = false; }
}
function processUploadQueue() {
  if (state.pendingUploads.length === 0) {
    uploadQueueBanner.classList.add('hidden');
    return;
  }
  uploadQueueBanner.classList.remove('hidden');
  const queue = [...state.pendingUploads];
  state.pendingUploads = [];
  saveState();
  queue.forEach(payload => sendToGoogleSheet(payload, true));
  setTimeout(() => uploadQueueBanner.classList.add('hidden'), 3000);
}

// ————————————————————————————————————————————————
// EVENT LISTENERS
// ————————————————————————————————————————————————
function initEventListeners() {
  // Location list
  locationList.addEventListener('click', e => {
    const item = e.target.closest('.selectable-item');
    if (!item) return;
    const editBtn = item.querySelector('.edit-location-btn');
    if (editBtn && e.target.closest('.edit-location-btn')) {
      openLocationModal(editBtn.dataset.id);
      return;
    }
    const id = item.querySelector('.edit-location-btn')?.dataset.id;
    if (id) {
      state.selectedLocationId = id;
      saveState();
      renderLocations();
      updateHomeScreenButtons();
    }
  });

  // Duration slider
  durationSlider.addEventListener('input', () => {
    state.visitDurationMinutes = DURATION_STEPS[durationSlider.value];
    durationDisplay.textContent = formatDuration(state.visitDurationMinutes);
    saveState();
    updateHomeScreenButtons();
  });

  // Long press buttons
  addLongPress(arrivedBtn, executeStartVisit);
  addLongPress(departBtn, departAndReport);
  addLongPress(extendBtn, extendVisit);
  addLongPress(iamSafeBtn, () => { playSoundAndVibrate('safe'); submitReport(); });

  // Quick stat
  quickStatBtn.addEventListener('click', quickStat);

  // SOS triple tap
  let sosTaps = 0;
  panicBtn.addEventListener('click', () => {
    sosTaps++;
    if (sosTaps === 3) {
      sosTaps = 0;
      sendAlert("SOS - MANUAL PANIC");
      showAlert("SOS SENT", "Emergency alerts dispatched");
    }
    setTimeout(() => sosTaps = 0, 1000);
  });

  // Modal buttons
  document.getElementById('addLocationBtn').addEventListener('click', () => openLocationModal());
  document.getElementById('infoBtn').addEventListener('click', () => showModal('info'));
  document.getElementById('settingsBtn').addEventListener('click', () => { populateSettingsUI(); navigate('settings'); });
  document.getElementById('closeSettingsBtn').addEventListener('click', () => navigate('main'));
  document.getElementById('cancelLocationBtn').addEventListener('click', hideModals);
  document.getElementById('saveLocationBtn').addEventListener('click', saveLocation);
  document.getElementById('deleteLocationBtn').addEventListener('click', () => {
    if (currentEditingLocationId && confirm("Delete this location?")) {
      state.locations = state.locations.filter(l => l.id !== currentEditingLocationId);
      if (state.selectedLocationId === currentEditingLocationId) state.selectedLocationId = null;
      saveState();
      renderLocations();
      updateHomeScreenButtons();
      hideModals();
    }
  });
  document.getElementById('useCurrentLocationBtn').addEventListener('click', async () => {
    try {
      const pos = await getCurrentPosition();
      const rev = await fetch(`https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point.lon=${pos.lng}&point.lat=${pos.lat}`);
      const data = await rev.json();
      if (data.features?.[0]?.properties?.label) {
        document.getElementById('locationAddress').value = data.features[0].properties.label;
      }
    } catch(e) { showAlert("GPS Error", "Could not get address"); }
  });
  document.getElementById('cancelReportBtn').addEventListener('click', () => { hideModals(); if (state.activeVisit) enterLockedScreen(); });
  document.getElementById('submitReportBtn').addEventListener('click', submitReport);
  document.getElementById('closeInfoModalBtn').addEventListener('click', hideModals);
// -- Settings Page Buttons --
  document.getElementById('saveSettingsBtn').addEventListener('click', () => {
    Object.keys(state.settings).forEach(k => {
      // FIX: Look for the element ID directly without regex replacement
      const el = document.getElementById(k);
      if (el) state.settings[k] = el.value.trim();
    });

    // Check if critical PINs are set before allowing exit
    if (!state.settings.pinCode || state.settings.pinCode.length !== 4) {
      alert("Please enter a valid 4-digit PIN to save.");
      return;
    }

    saveState();
    navigate('main');

    // FIX: Re-enable the close button so it works for the rest of the session
    document.getElementById('closeSettingsBtn').style.opacity = '1';
    document.getElementById('closeSettingsBtn').style.pointerEvents = 'auto';
  });

  document.getElementById('closeSettingsBtn').addEventListener('click', () => navigate('main'));
  
  document.getElementById('clearCacheBtn').addEventListener('click', () => {
    if(confirm("Reset all app data?")) { localStorage.clear(); location.reload(); }
  });
  document.getElementById('alertModalOkBtn').addEventListener('click', hideModals);
  document.getElementById('checkinOkBtn').addEventListener('click', () => {
    clearInterval(checkinCountdownInterval);
    hideModals();
    document.getElementById('alertActiveContainer').classList.add('hidden');
    document.getElementById('normalButtonsContainer').classList.remove('hidden');
    state.activeVisit.alertActive = false;
    extendVisit();
    saveState();
  });
}

function populateSettingsUI() {
  Object.keys(state.settings).forEach(k => {
    // FIX: Removed .replace(...) to match IDs directly (e.g. "workerName" matches "workerName")
    const el = document.getElementById(k); 
    if (el) el.value = state.settings[k] || '';
  });
  
  if(document.getElementById('googleSheetUrl')) {
      document.getElementById('googleSheetUrl').disabled = true;
  }
}
function showAlert(title, msg) {
  document.getElementById('alertModalTitle').textContent = title;
  document.getElementById('alertModalMessage').textContent = msg;
  showModal('alert');
}

function init() {
  pages = {
    main: document.getElementById('mainPage'),
    locked: document.getElementById('lockedPage'),
    settings: document.getElementById('settingsPage')
  };
  modals = {
    backdrop: document.getElementById('modalBackdrop'),
    location: document.getElementById('locationModal'),
    report: document.getElementById('reportModal'),
    info: document.getElementById('infoModal'),
    alert: document.getElementById('alertModal'),
    checkin: document.getElementById('checkinModal')
  };
  locationList = document.getElementById('locationList');
  arrivedBtn = document.getElementById('arrivedBtn');
  quickStatBtn = document.getElementById('quickStatBtn');
  durationSlider = document.getElementById('durationSlider');
  durationDisplay = document.getElementById('durationDisplay');
  reportFormChecklists = document.getElementById('reportFormChecklists');
  reportNotes = document.getElementById('reportNotes');
  reportLoading = document.getElementById('reportLoading');
  reportModalTitle = document.getElementById('reportModalTitle');
  uploadQueueBanner = document.getElementById('uploadQueueBanner');
  startReminderBanner = document.getElementById('startReminderBanner');

  loadState();
  renderLocations();
  durationSlider.value = DURATION_STEPS.indexOf(state.visitDurationMinutes) || 0;
  durationDisplay.textContent = formatDuration(state.visitDurationMinutes);

  const needsSetup = !state.settings.pinCode || state.settings.pinCode.length !== 4 ||
                     !state.settings.duressPin || state.settings.duressPin.length !== 4;
  if (needsSetup) {
    populateSettingsUI();
    navigate('settings');
    document.getElementById('closeSettingsBtn').style.opacity = '0.3';
    document.getElementById('closeSettingsBtn').style.pointerEvents = 'none';
    setTimeout(() => showAlert("First-Time Setup", "Please complete ALL fields including both 4-digit PINs"), 800);
  } else if (state.activeVisit) {
    enterLockedScreen();
  } else {
    navigate('main');
    syncAllForms();
    processUploadQueue();
  }
  initEventListeners();
  updateHomeScreenButtons();
}

window.addEventListener('load', init);
</script>
</body>
</html>
