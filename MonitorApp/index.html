<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .grid-area { flex: 1; overflow-y: auto; padding: 1.5rem; position: relative; }
        .log-area { flex: 0 0 300px; background-color: #1e293b; border-left: 1px solid #334155; overflow-y: auto; display: flex; flex-direction: column; }
        .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; transition: all 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .st-ok { background-color: #10b981; box-shadow: 0 0 10px #10b981; } 
        .st-amber { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; animation: blinker 2s linear infinite; } 
        .st-red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; animation: blinker 0.5s linear infinite; } 
        .st-purple { background-color: #d946ef; box-shadow: 0 0 15px #d946ef; animation: blinker 0.3s linear infinite; }
        .st-grey { background-color: #64748b; } 
        .bd-green { border-color: #059669; border-width: 2px; }
        .bd-amber { border-color: #d97706; border-width: 2px; }
        .bd-red { border-color: #dc2626; border-width: 4px; }
        .bd-purple { border-color: #c026d3; border-width: 5px; }
        .bd-grey { border-color: #475569; opacity: 0.7; }
        #fullScreenAlert { z-index: 50; }
        .alert-red { animation: pulseRed 1s infinite; }
        .alert-purple { animation: pulsePurple 1s infinite; }
        @keyframes pulseRed { 0% { background-color: rgba(220, 38, 38, 0.9); } 50% { background-color: rgba(153, 27, 27, 0.95); } 100% { background-color: rgba(220, 38, 38, 0.9); } }
        @keyframes pulsePurple { 0% { background-color: rgba(147, 51, 234, 0.9); } 50% { background-color: rgba(107, 33, 168, 0.95); } 100% { background-color: rgba(147, 51, 234, 0.9); } }
        #mapView { background: #020617; z-index: 1; width: 100%; height: 100%; }
        .custom-div-icon { background: transparent; border: none; } 
        .map-icon { width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); display: block; }
        .map-icon.red { background: #ef4444; animation: blinker 0.8s linear infinite; box-shadow: 0 0 20px #ef4444; }
        .map-icon.purple { background: #d946ef; animation: blinker 0.3s linear infinite; box-shadow: 0 0 25px #d946ef; }
        .map-icon.green { background: #10b981; }
        .map-icon.amber { background: #f59e0b; }
        .map-icon.grey { background: #64748b; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">
    <div id="startOverlay" class="fixed inset-0 z-[100] bg-gray-900 flex items-center justify-center p-4">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white mb-4" id="overlayTitle">Monitor</h1>
            <button onclick="startApp()" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-2xl text-xl transition transform hover:scale-105">
                üîä CLICK TO START
            </button>
        </div>
    </div>

    <div id="fullScreenAlert" class="hidden fixed inset-0 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
        <div class="text-9xl mb-4" id="alertIcon">üö®</div>
        <h1 class="text-6xl font-black text-white mb-4 drop-shadow-md" id="alertTitle">EMERGENCY ALERT</h1>
        <h2 id="alertNames" class="text-4xl font-bold text-white bg-black/30 px-6 py-2 rounded mb-8">Worker Name</h2>
        <button onclick="acknowledgeAlert()" class="bg-white text-gray-900 font-black text-2xl py-6 px-12 rounded-full shadow-2xl hover:scale-105 transition border-4 border-gray-900">ACKNOWLEDGE</button>
    </div>

    <header class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center shrink-0 z-20">
        <div class="flex items-center gap-3">
            <img src="icon.png" class="w-8 h-8 rounded bg-white object-contain p-1">
            <div>
                <h1 class="font-bold text-xl"><span id="headerTitle">Monitor</span> <span id="verTag" class="text-xs font-normal text-gray-500 ml-2"></span></h1>
                <div class="text-xs text-gray-400" id="statusIndicator">Connecting...</div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="btnAudio" onclick="toggleAudio()" class="px-3 py-1 rounded text-sm font-bold bg-green-600 text-white border border-green-500">üîä Sound On</button>
            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600 ml-4">
                <button onclick="setFilter('ACTIVE')" id="btnFilterActive" class="px-3 py-1 rounded text-xs font-bold bg-blue-600 text-white shadow">üü¢ Active</button>
                <button onclick="setFilter('ALL')" id="btnFilterAll" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white">üìã All</button>
            </div>
            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600">
                <button onclick="toggleView('GRID')" id="btnGrid" class="px-3 py-1 rounded text-xs font-bold bg-gray-600 text-white">‚äû Grid</button>
                <button onclick="toggleView('MAP')" id="btnMap" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white">üó∫Ô∏è Map</button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <div class="grid-area">
            <div id="workerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            <div id="mapView" class="hidden h-full w-full rounded-xl overflow-hidden shadow-inner border border-gray-700 bg-gray-900 relative"></div>
        </div>
        <div class="log-area">
            <div class="p-2 bg-gray-800 border-b border-gray-700 font-bold text-[10px] text-gray-400 uppercase tracking-wider sticky top-0">Activity Log</div>
            <div id="eventLogList" class="flex-1 overflow-y-auto px-2 py-2 space-y-1"></div>
        </div>
    </div>

<script>
    // FIX 4: Safety check for CONFIG and usage of config.js variables
    if(typeof CONFIG === 'undefined') {
        alert("CRITICAL ERROR: config.js is missing or corrupt. Please re-run Factory.");
    } else {
        document.getElementById('headerTitle').innerText = (CONFIG.org || "Safety") + " Monitor";
        document.getElementById('overlayTitle').innerText = (CONFIG.org || "Safety") + " Monitor";
        document.getElementById('verTag').innerText = CONFIG.version || "v93.0";
    }

    // FIX 5: Use Key from Config, fallback to local storage
    const API_KEY = (typeof CONFIG !== 'undefined' ? CONFIG.monitorKey : null) || localStorage.getItem('otg_monitor_key');
    const SERVER_URL = (typeof CONFIG !== 'undefined' ? CONFIG.url : "");

    let workerData = []; let allRows = []; let mapInstance = null, markersLayer = null, currentView = 'GRID'; let currentFilter = 'ACTIVE'; let audioEnabled = true, synth = null; let acknowledgedAlerts = new Set(); let alertLoopInterval = null;

    async function startApp() {
        document.getElementById('startOverlay').classList.add('hidden');
        try { if(typeof Tone !== 'undefined') { await Tone.start(); synth = new Tone.Synth().toDestination(); } } catch(e){}
        
        if(!API_KEY) { 
            const k = prompt("Enter Secret Key:"); 
            if(k) { localStorage.setItem('otg_monitor_key', k); location.reload(); } 
        }
        else { 
            fetchData(); 
            setInterval(fetchData, 5000); 
        }
    }

    function fetchData() {
        if(!SERVER_URL) return console.error("No Server URL");
        
        fetch(`${SERVER_URL}?action=fetch&key=${encodeURIComponent(API_KEY)}`)
        .then(r=>r.json())
        .then(d=>{
            if(d.error) return alert("Security Error: " + d.error);
            document.getElementById('statusIndicator').innerText = "Online " + new Date().toLocaleTimeString();
            processData(d.workers);
        })
        .catch(e=>console.warn("Connection Error", e));
    }

    function processData(rows) {
        allRows = rows;
        workerData = rows.map(r => ({
            name: r['Worker Name'], status: r['Alarm Status'], phone: r['Worker Phone Number'],
            location: r['Location Name'] || r['Location Address'] || "Unknown",
            gps: r['Last Known GPS'], battery: r['Battery Level'], dueTime: r['Anticipated Departure Time'],
            timestamp: new Date(r['Timestamp']).getTime()
        }));
        
        checkAlerts();
        if(currentView === 'MAP') renderMap(); else renderGrid();
        renderLog();
    }

    function renderGrid() {
        const g = document.getElementById('workerGrid'); g.innerHTML = '';
        const now = Date.now();
        
        workerData.forEach(w => {
            const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE');
            if (currentFilter === 'ACTIVE' && isSafe && !w.status.includes('EMERGENCY')) return;

            let borderClass = 'bd-grey', dotClass = 'st-grey';
            if(w.status.includes('EMERGENCY')) { borderClass = 'bd-red'; dotClass = 'st-red'; }
            else if(!isSafe) { borderClass = 'bd-green'; dotClass = 'st-ok'; }

            const div = document.createElement('div');
            div.className = `card p-4 ${borderClass}`;
            div.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-white truncate w-full">${w.name}</h3><div class="${dotClass} status-dot mt-1.5 shrink-0 ml-2"></div></div><div class="space-y-1.5 text-xs text-gray-300"><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Status</span><span class="font-bold">${w.status}</span></div><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Location</span><span class="truncate w-24 text-right">${w.location}</span></div><div class="flex justify-between"><span class="text-gray-500 uppercase font-bold">Battery</span><span>${w.battery}</span></div></div>`;
            g.appendChild(div);
        });
    }

    function initMap() {
        if(mapInstance) { mapInstance.invalidateSize(); return; }
        mapInstance = L.map('mapView').setView([-40.9006, 174.8860], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(mapInstance);
        markersLayer = L.layerGroup().addTo(mapInstance);
    }

    function renderMap() {
        if(!mapInstance) return;
        markersLayer.clearLayers();
        const bounds = L.latLngBounds();
        let hasMarkers = false;
        
        workerData.forEach(w => {
            const isSafe = w.status === 'DEPARTED' || w.status === 'COMPLETED' || w.status.includes('SAFE');
            if (currentFilter === 'ACTIVE' && isSafe && !w.status.includes('EMERGENCY')) return;
            if(!w.gps || w.gps.length < 5) return;
            
            const parts = w.gps.replace(/[^0-9.,-]/g, '').split(',');
            if(parts.length !== 2) return;
            
            let color = w.status.includes('EMERGENCY') ? 'red' : 'green';
            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="map-icon ${color}"></div>`, iconSize: [24, 24] });
            L.marker([parseFloat(parts[0]), parseFloat(parts[1])], {icon: icon}).bindPopup(`<b>${w.name}</b><br>${w.status}`).addTo(markersLayer);
            bounds.extend([parseFloat(parts[0]), parseFloat(parts[1])]);
            hasMarkers = true;
        });
        if(hasMarkers && !mapInstance._isFocused) mapInstance.fitBounds(bounds, {padding:[50,50], maxZoom:15});
    }

    function toggleView(view) {
        currentView = view;
        document.getElementById('workerGrid').classList.toggle('hidden', view === 'MAP');
        document.getElementById('mapView').classList.toggle('hidden', view === 'GRID');
        document.getElementById('btnGrid').classList.toggle('bg-gray-600', view === 'GRID');
        document.getElementById('btnMap').classList.toggle('bg-gray-600', view === 'MAP');
        if(view === 'MAP') setTimeout(() => { initMap(); renderMap(); }, 150);
    }

    function renderLog() {
        const list = document.getElementById('eventLogList');
        const sorted = [...allRows].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp)).slice(0, 50);
        let html = '';
        sorted.forEach(r => {
            const time = new Date(r['Timestamp']).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let color = r['Alarm Status'].includes("EMERGENCY") ? "text-red-400 font-bold" : "text-gray-300";
            html += `<div class="text-[10px] mb-1"><span class="text-gray-500 font-mono mr-2">${time}</span><span class="${color}">${r['Worker Name']}: ${r['Alarm Status']}</span></div>`;
        });
        list.innerHTML = html;
    }

    function checkAlerts() {
        const alertWorkers = workerData.filter(w => w.status.includes("EMERGENCY") || w.status.includes("PANIC"));
        const unacked = alertWorkers.filter(w => !acknowledgedAlerts.has(w.name));
        const alertBox = document.getElementById('fullScreenAlert');
        
        if(unacked.length > 0) {
            alertBox.classList.remove('hidden'); alertBox.classList.add('alert-red');
            document.getElementById('alertNames').innerText = unacked.map(w => w.name).join(", ");
            startAlertLoop();
        } else {
            alertBox.classList.add('hidden'); stopAlertLoop();
        }
    }

    function startAlertLoop() { if(alertLoopInterval) return; alertLoopInterval = setInterval(() => { if(audioEnabled && synth) { synth.triggerAttackRelease("C6", "0.1"); } }, 1000); }
    function stopAlertLoop() { if(alertLoopInterval) { clearInterval(alertLoopInterval); alertLoopInterval = null; } }
    function acknowledgeAlert() { 
        workerData.forEach(w => { if(w.status.includes("EMERGENCY")) acknowledgedAlerts.add(w.name); });
        document.getElementById('fullScreenAlert').classList.add('hidden'); stopAlertLoop();
    }
    function toggleAudio() { audioEnabled = !audioEnabled; document.getElementById('btnAudio').innerText = audioEnabled ? "üîä Sound On" : "üîá Sound Off"; }
    function setFilter(f) { currentFilter = f; renderGrid(); if(currentView === 'MAP') renderMap(); }
</script>
</body>
</html>
